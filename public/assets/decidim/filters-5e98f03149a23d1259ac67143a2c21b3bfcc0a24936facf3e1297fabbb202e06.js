"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function t(t,e){var i=[],n=!0,r=!1,a=undefined;try{for(var o,c=t[Symbol.iterator]();!(n=(o=c.next()).done)&&(i.push(o.value),!e||i.length!==e);n=!0);}catch(s){r=!0,a=s}finally{try{!n&&c["return"]&&c["return"]()}finally{if(r)throw a}}return i}return function(e,i){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();!function(t){var e=function(){function e(i){_classCallCheck(this,e),this.$form=i,this.id=this.$form.attr("id")||this._getUID(),this.mounted=!1,this.changeEvents=!0,this._updateInitialState(),this._onFormChange=t.delayed(this,this._onFormChange.bind(this)),this._onPopState=this._onPopState.bind(this),window.Decidim.PopStateHandler?this.popStateSubmiter=!1:(this.popStateSubmiter=!0,window.Decidim.PopStateHandler=this.id)}return _createClass(e,[{key:"unmountComponent",value:function(){this.mounted&&(this.mounted=!1,this.$form.off("change","input, select",this._onFormChange),t.Decidim.History.unregisterCallback("filters-"+this.id))}},{key:"mountComponent",value:function(){var e=this;this.$form.length>0&&!this.mounted&&(this.mounted=!0,this.$form.on("change","input:not([data-disable-dynamic-change]), select:not([data-disable-dynamic-change])",this._onFormChange),this.currentFormRequest=null,this.$form.on("ajax:beforeSend",function(t){e.currentFormRequest&&e.currentFormRequest.abort(),e.currentFormRequest=t.originalEvent.detail[0]}),t.theCheckBoxesTree.setContainerForm(this.$form),t.Decidim.History.registerCallback("filters-"+this.id,function(t){e._onPopState(t)}))}},{key:"_updateInitialState",value:function(){var e=this._currentStateAndPath(),i=_slicedToArray(e,2),n=i[0],r=i[1];r._path=n,t.Decidim.History.replaceState(null,r)}},{key:"_getLocation",value:function(){var e=arguments.length<=0||arguments[0]===undefined||arguments[0],i=t.Decidim.History.state(),n="";return n=i&&i._path?i._path:t.location.pathname+t.location.search+t.location.hash,e?t.location.origin+n:n}},{key:"_parseLocationFilterValues",value:function(){var t=decodeURIComponent(this._getLocation()).match(/filter\[([^\]]*)\](?:\[\])?=([^&]*)/g);return t?t.reduce(function(t,e){var i=e.match(/filter\[([^\]]*)\](\[\])?=([^&]*)/),n=_slicedToArray(i,4),r=n[1],a=n[2],o=n[3];return a?(t[r]||(t[r]=[]),t[r].push(o)):t[r]=o,t},{}):null}},{key:"_parseLocationOrderValue",value:function(){var t=this._getLocation().match(/order=([^&]*)/),e=this.$form.find(".order-by .menu").find(".menu a:first").data("order");return t&&(e=t[1]),e}},{key:"_clearForm",value:function(){this.$form.find("input[type=checkbox]").each(function(t,e){e.checked=e.indeterminate=!1}),this.$form.find("input[type=radio]").attr("checked",!1),this.$form.find(".data-picker").each(function(e,i){t.theDataPicker.clear(i)}),this.$form.find("fieldset input[type=radio]:first").each(function(){$(this)[0].checked=!0})}},{key:"_onPopState",value:function(e){var i=this;this.changeEvents=!1,this._clearForm();var n=this._parseLocationFilterValues(),r=this._parseLocationOrderValue();(this.$form.find("input.order_filter").val(r),n)&&Object.keys(n).forEach(function(t){var e=n[t];if(Array.isArray(e)){var r=i.$form.find('input[type=checkbox][name="filter['+t+'][]"]');window.theCheckBoxesTree.updateChecked(r,e)}else i.$form.find('*[name="filter['+t+']"]').each(function(t,i){switch(i.type){case"hidden":break;case"radio":case"checkbox":i.checked=e===i.value;break;default:i.value=e}})});$(".data-picker",this.$form).each(function(i,n){var r=e[n.id];r&&t.theDataPicker.load(n,r)}),this.popStateSubmiter&&t.Rails.fire(this.$form[0],"submit"),this.changeEvents=!0}},{key:"_onFormChange",value:function(){if(this.changeEvents){var e=this._currentStateAndPath(),i=_slicedToArray(e,2),n=i[0],r=i[1];n!==this._getLocation(!1)&&(t.Rails.fire(this.$form[0],"submit"),t.Decidim.History.pushState(n,r))}}},{key:"_currentStateAndPath",value:function(){var e=this.$form.attr("action"),i=this.$form.find(":not(.ignore-filters)").find("select:not(.ignore-filter), input:not(.ignore-filter)").serialize(),n="",r={};return n=e.indexOf("?")<0?e+"?"+i:e+"&"+i,$(".data-picker",this.$form).each(function(e,i){r[i.id]=t.theDataPicker.save(i)}),[n,r]}},{key:"_getUID",value:function(){return"filter-form-"+(new Date).setUTCMilliseconds()+"-"+Math.floor(1e7*Math.random())}}]),e}();t.Decidim=t.Decidim||{},t.Decidim.FormFilterComponent=e}(window),function(){var t=window.Decidim.FormFilterComponent;$(function(){$("form.new_filter").each(function(){new t($(this)).mountComponent()})})}();